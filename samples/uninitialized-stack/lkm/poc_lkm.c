#include <linux/kernel.h>
#include <linux/init.h>
#include <linux/module.h>
#include <linux/msg.h>
#include <asm/uaccess.h>
#include <linux/slab.h>
#include <linux/mm.h>
#include <linux/proc_fs.h>

char poc_lkm_str[256] = "Hello_World";

struct poc_lkm_size {
	char dummy[128];
};

struct poc_lkm_st_0 {
	int val;
	char name[128];
	unsigned long low;
	unsigned long high;
	unsigned int flags;
	unsigned short mode;
	unsigned short signal;
};

struct poc_lkm_st_1 {
	char name[16];
	unsigned int dummy;
	unsigned int datasize;
	unsigned char *data;
};

struct poc_lkm_user_st {
	unsigned int datasize;
	unsigned char *data;
};

#define POC_LKM_IOCTL_MAGIC ('P')
#define POC_LKM_CMD_0 _IOWR(POC_LKM_IOCTL_MAGIC, 0, struct poc_lkm_size)
#define POC_LKM_CMD_1 _IOWR(POC_LKM_IOCTL_MAGIC, 1, struct poc_lkm_size)
#define POC_LKM_CMD_2 _IOWR(POC_LKM_IOCTL_MAGIC, 2, struct poc_lkm_size)

static int poc_lkm_get_code(struct poc_lkm_st_1 *pst, struct poc_lkm_user_st *ust)
{
	if (copy_from_user(pst->data, ust->data, ust->datasize))
		return -1;
	return 0;
}

static int poc_lkm_set_st_0(struct poc_lkm_st_0 *pst, struct poc_lkm_user_st *ust)
{
	if (copy_from_user(pst, ust->data, ust->datasize))
		return -1;
	return 0;
}

static long poc_lkm_ioctl(struct file *f, unsigned int cmd, unsigned long arg)
{
	int r = 0;

	union {
		struct poc_lkm_st_0 st0;
		struct poc_lkm_st_1 st1;
	}karg;

	switch (cmd) {
	case POC_LKM_CMD_0:
		pr_info("cmd_0 stack : %lx\n", &karg.st1.data);
		r = poc_lkm_set_st_0(&karg.st0, arg);
		pr_info("cmd_0 pst->data : %lx\n", karg.st1.data);
		break;
	case POC_LKM_CMD_1:
		pr_info("cmd_1 stack : %lx\n", &karg.st1.data);
		r = poc_lkm_get_code(&karg.st1, arg);
		break;
	case POC_LKM_CMD_2:
		pr_info("str : %s\n", poc_lkm_str);
		break;
	}
	
	return r;
}

static struct file_operations poc_lkm_fops =
{
    .owner = THIS_MODULE,
    .unlocked_ioctl = poc_lkm_ioctl,
};

static int create_poc_lkm_fops(void)
{
    proc_create("poc_lkm", 0666, NULL, &poc_lkm_fops);
    return 0;
}

static int remove_poc_lkm_fops(void)
{
    remove_proc_entry("poc_lkm", NULL);
    return 0;
}

int poc_lkm_init(void)
{
	create_poc_lkm_fops();
	return 0;
}

void poc_lkm_exit(void)
{
	remove_poc_lkm_fops();
	return;
}

module_init(poc_lkm_init);
module_exit(poc_lkm_exit);
MODULE_LICENSE("GPL");
